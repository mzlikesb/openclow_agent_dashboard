<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Luca Session Garden</title>
  <style>
    :root{--bg:#0f1221;--glow:#2c2e6e;--card:#1a2040;--card2:#151a33;--line:#303a75;--text:#f8f7ff;--muted:#b8b9d9;--chip:#20285a;--chipLine:#374394;--btn:#1e2550;--btnLine:#3a4699;--btnText:#e7ebff;--hero1:#2b2f68;--hero2:#202656;--heroLine:#4957bf;--heroItem:#141a3b;--heroItemLine:#38438d;--barBg:#0a0d1f;--barLine:#2f3566}
    html[data-theme='light']{--bg:#f5f7ff;--glow:#dbe4ff;--card:#ffffff;--card2:#f7f9ff;--line:#d7defa;--text:#1b2240;--muted:#5f688f;--chip:#eef2ff;--chipLine:#c8d4ff;--btn:#edf2ff;--btnLine:#c8d4ff;--btnText:#1f2a57;--hero1:#eef2ff;--hero2:#dfe8ff;--heroLine:#b8c8ff;--heroItem:#ffffff;--heroItemLine:#cfdbff;--barBg:#eef2ff;--barLine:#c8d4ff}
    *{box-sizing:border-box}
    body{font-family:ui-rounded,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:radial-gradient(1200px 600px at 80% -10%,var(--glow) 0%,var(--bg) 60%);color:var(--text);margin:0;padding:20px}
    .wrap{max-width:1100px;margin:0 auto}
    .title{font-size:30px;font-weight:900}
    .sub{opacity:.85;margin:8px 0 14px;color:var(--muted)}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
    .chip{background:var(--chip);border:1px solid var(--chipLine);padding:8px 12px;border-radius:999px;font-size:13px}
    .theme-wrap{display:flex;justify-content:flex-end;margin:6px 0 12px;gap:8px}
    .btn{background:var(--btn);border:1px solid var(--btnLine);color:var(--btnText);padding:7px 12px;border-radius:999px;font-size:12px;cursor:pointer}
    .btn.active{background:#6d6cff;border-color:#8f8eff;color:#fff;font-weight:700}
    .hero{background:linear-gradient(145deg,var(--hero1),var(--hero2));border:1px solid var(--heroLine);border-radius:18px;padding:16px;margin-bottom:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .hero-title{font-size:14px;font-weight:700;opacity:.9;margin-bottom:10px}
    .hero-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:10px}
    .hero-item{background:var(--heroItem);border:1px solid var(--heroItemLine);border-radius:12px;padding:10px}
    .hero-item .label{font-size:13px;font-weight:800;margin-bottom:6px}
    .section{margin:18px 0 8px;font-size:16px;font-weight:800;display:flex;align-items:center;gap:8px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px}

    /* Collapsible Card */
    .card{background:linear-gradient(145deg,var(--card),var(--card2));border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.22);overflow:hidden}
    .card-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;cursor:pointer;user-select:none;gap:8px}
    .card-header:hover{background:rgba(255,255,255,.04)}
    .card-header-left{display:flex;align-items:center;gap:8px;min-width:0;flex:1}
    .card-name{font-size:13px;font-weight:800;word-break:break-all;opacity:.9}
    .card-header-right{display:flex;align-items:center;gap:6px;flex-shrink:0}
    .chevron{font-size:12px;opacity:.6;transition:transform .2s;display:inline-block}
    .card.expanded .chevron{transform:rotate(180deg)}
    .card-body{padding:0 14px 14px;display:none}
    .card.expanded .card-body{display:block}

    .name{font-size:13px;font-weight:800;word-break:break-all;margin-bottom:8px;opacity:.9}
    .row{display:flex;justify-content:space-between;gap:10px;align-items:center;margin:4px 0}
    .k{font-size:12px;opacity:.72}
    .v{font-size:13px}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;font-weight:700}
    .ACTIVE{background:#123a2b;color:#80ffc6}
    .IDLE{background:#3a3520;color:#ffe79e}
    .STALE{background:#3b2020;color:#ffabab}
    .UNKNOWN{background:#2d2d2d;color:#ddd}
    .type{background:#2a3170;color:#d8ddff}
    .bar{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:var(--barBg);border:1px solid var(--barLine);padding:6px 8px;border-radius:8px;margin-top:8px;letter-spacing:.4px;font-size:12px}
    .tiny{opacity:.68;font-size:11px;margin-top:8px}
    .footer{opacity:.55;margin-top:16px;font-size:12px}
    .empty{opacity:.7;border:1px dashed var(--heroLine);border-radius:12px;padding:14px;text-align:center}
    /* Model border colors */
    .model-gemini{border-left:3px solid #4caf50}
    .model-claude{border-left:3px solid #d97757}
    .model-codex{border-left:3px solid #2196f3}
    .model-other{border-left:3px solid #888}
    /* Luca team top border */
    .luca-main{border-top:3px solid #6d6cff}
    .luca-reviewer{border-top:3px solid #f06292}
    .luca-worker{border-top:3px solid #ffb74d}
    .usage-bar-wrap{height:8px;background:rgba(255,255,255,.1);border-radius:4px;margin-top:6px;overflow:hidden}
    .usage-bar-fill{height:100%;border-radius:4px;transition:width .3s}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="title">ğŸ’œ Luca Session Garden</div>
        <div class="sub">ê·€ì—½ê²Œ ë³´ëŠ” ì‹¤ì‹œê°„ ì„¸ì…˜ í˜„í™©íŒ (3ì´ˆ ê°±ì‹ )</div>
      </div>
      <div class="theme-wrap">
        <a class="btn" href="/three.html" style="text-decoration:none;display:inline-flex;align-items:center;">ğŸ® 3D</a>
        <button class="btn" id="themeBtn">ğŸŒ™</button>
      </div>
    </div>

    <!-- Model Usage -->
    <div class="hero" id="modelHero">
      <div class="hero-title">ğŸ“Š ëª¨ë¸ë³„ ì‚¬ìš©ëŸ‰ (Active Sessions / Total Tokens)</div>
      <div class="hero-grid" id="modelGrid"></div>
    </div>

    <!-- Quota Resets -->
    <div class="hero" id="quotaHero">
      <div class="hero-title">â° í• ë‹¹ëŸ‰ ë¦¬ì…‹ ì‹œê°„</div>
      <div class="hero-grid" id="quotaGrid"></div>
    </div>

    <!-- Luca Team Status -->
    <div class="hero" id="lucaTeamHero">
      <div class="hero-title">ğŸ­ ë£¨ì¹´ íŒ€ í˜„í™© (Main / Reviewer / Worker)</div>
      <div class="hero-grid" id="lucaTeamGrid"></div>
    </div>

    <div class="chips" id="chips"></div>

    <div id="sections"></div>
    <div class="footer">ACTIVE: ìµœê·¼ 20ë¶„ Â· IDLE: 20~180ë¶„ Â· STALE: 180ë¶„ ì´ˆê³¼ ë˜ëŠ” aborted</div>
  </div>

  <script>
    const TYPE_META = {
      MAIN:     { icon: 'ğŸ‘‘', name: 'ë©”ì¸ ì„¸ì…˜' },
      REVIEWER: { icon: 'ğŸ”', name: 'ë¦¬ë·°ì–´ ì„¸ì…˜' },
      WORKER:   { icon: 'ğŸ› ï¸', name: 'ì›Œì»¤ ì„¸ì…˜' },
      CRON:     { icon: 'â°', name: 'í¬ë¡  ì„¸ì…˜' },
      SUBAGENT: { icon: 'ğŸ¤–', name: 'ì„œë¸Œì—ì´ì „íŠ¸ ì„¸ì…˜' },
      OTHER:    { icon: 'ğŸ§©', name: 'ê¸°íƒ€ ì„¸ì…˜' },
    };

    // Track which cards are expanded (persisted by key)
    const expandedKeys = new Set(JSON.parse(localStorage.getItem('luca-expanded') || '[]'));
    let latestData = null;

    function saveExpanded() {
      localStorage.setItem('luca-expanded', JSON.stringify([...expandedKeys]));
    }

    function applyTheme(theme){
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('luca-theme', theme);
      const btn = document.getElementById('themeBtn');
      if(btn) btn.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    function initTheme(){
      const saved = localStorage.getItem('luca-theme');
      applyTheme(saved || 'dark');
      document.getElementById('themeBtn').onclick = () => {
        const now = document.documentElement.getAttribute('data-theme') || 'dark';
        applyTheme(now === 'dark' ? 'light' : 'dark');
      };
    }

    function humanizeAge(ageMin){
      if(ageMin === null || ageMin === undefined || Number.isNaN(ageMin)) return '-';
      const totalMin = Math.max(0, Math.floor(Number(ageMin)));
      const d = Math.floor(totalMin / 1440);
      const h = Math.floor((totalMin % 1440) / 60);
      const m = totalMin % 60;
      const parts = [];
      if(d > 0) parts.push(`${d}ì¼`);
      if(h > 0 || d > 0) parts.push(`${h}ì‹œê°„`);
      parts.push(`${m}ë¶„`);
      return parts.join(' ');
    }

    function fmtTokens(n) {
      if(n >= 1000000) return (n/1000000).toFixed(1) + 'M';
      if(n >= 1000) return (n/1000).toFixed(1) + 'k';
      return String(n);
    }

    function cardHTML(s){
      const cardKey = s.key;
      const isExpanded = expandedKeys.has(cardKey);
      const name = `${s.label ? s.label+' Â· ' : ''}${s.key}`;
      const familyCls = (s.family === 'Gemini Pro' || s.family === 'Gemini Flash') ? 'model-gemini' : s.family === 'Claude' ? 'model-claude' : s.family === 'Codex' ? 'model-codex' : 'model-other';

      return `
        <div class="card ${familyCls}${isExpanded ? ' expanded' : ''}" data-key="${cardKey}">
          <div class="card-header" onclick="toggleCard('${cardKey}')">
            <div class="card-header-left">
              <div class="card-name">${name}</div>
            </div>
            <div class="card-header-right">
              <span class="badge ${s.state}">${s.state}</span>
              <span class="badge type">${s.type}</span>
              <span class="chevron">â–¼</span>
            </div>
          </div>
          <div class="card-body">
            <div class="row"><div class="k">ëª¨ë¸</div><div class="v" style="font-size:11px">${s.model || '-'}</div></div>
            <div class="row"><div class="k">ì±„ë„</div><div class="v">${s.channel || '-'}</div></div>
            <div class="row"><div class="k">í† í°</div><div class="v">${(s.totalTokens||0).toLocaleString()} / ${(s.contextTokens||0).toLocaleString()} (${s.percent}%)</div></div>
            <div class="bar">${s.bar}</div>
            <div class="tiny">ìµœê·¼ ì—…ë°ì´íŠ¸: ${humanizeAge(s.ageMin)} ì „${s.abortedLastRun ? ' Â· aborted' : ''}</div>
          </div>
        </div>
      `;
    }

    function toggleCard(key) {
      if(expandedKeys.has(key)) {
        expandedKeys.delete(key);
      } else {
        expandedKeys.add(key);
      }
      saveExpanded();
      // Toggle DOM directly without full re-render
      const el = document.querySelector(`.card[data-key="${CSS.escape(key)}"]`);
      if(el) el.classList.toggle('expanded', expandedKeys.has(key));
    }

    function renderQuotaResets(quotaResets) {
      const el = document.getElementById('quotaGrid');
      if(!el) return;
      if(!quotaResets || Object.keys(quotaResets).length === 0) {
        el.innerHTML = "<div class='empty'>ë°ì´í„° ì—†ìŒ</div>";
        return;
      }
      const COLORS = {
        gemini_pro:       '#4caf50',
        gemini_flash:     '#8bc34a',
        codex_primary:    '#2196f3',
        codex_secondary:  '#42a5f5',
      };
      const ICONS = {
        gemini_pro:       'ğŸŸ¢',
        gemini_flash:     'ğŸŸ¡',
        codex_primary:    'ğŸ”µ',
        codex_secondary:  'ğŸ”¹',
      };
      let html = '';
      for(const [key, info] of Object.entries(quotaResets)) {
        const color = COLORS[key] || '#888';
        const icon = ICONS[key] || 'âš«';
        html += `
          <div class="hero-item" style="border-left:3px solid ${color}">
            <div class="label">${icon} ${info.label}</div>
            <div style="font-size:22px;font-weight:900;margin:6px 0;color:${color}">${info.remaining}</div>
            <div style="font-size:10px;opacity:.55">í›„ ë¦¬ì…‹</div>
          </div>`;
      }
      el.innerHTML = html;
    }

    function renderModelStats(usage) {
      if(!usage) return;
      const COLORS = { 'Gemini Pro':'#4caf50', 'Gemini Flash':'#8bc34a', Claude:'#d97757', Codex:'#2196f3', Other:'#888' };
      const ICONS  = { 'Gemini Pro':'ğŸŸ¢', 'Gemini Flash':'ğŸŸ¡', Claude:'ğŸŸ ', Codex:'ğŸ”µ', Other:'âš«' };
      const totalTokens = Object.values(usage).reduce((a,b) => a + b.tokens, 0);
      let html = '';
      for(const [family, stats] of Object.entries(usage)) {
        const pct = totalTokens > 0 ? Math.round((stats.tokens / totalTokens) * 100) : 0;
        html += `
          <div class="hero-item">
            <div class="label">${ICONS[family]||'âš«'} ${family}</div>
            <div class="row"><div class="k">Active</div><div class="v" style="color:${COLORS[family]||'#fff'};font-weight:800">${stats.active} <span style="opacity:.5;font-size:11px">/ ${stats.count}</span></div></div>
            <div class="row"><div class="k">Tokens</div><div class="v">${fmtTokens(stats.tokens)}</div></div>
            <div class="usage-bar-wrap"><div class="usage-bar-fill" style="width:${pct}%;background:${COLORS[family]||'#888'}"></div></div>
            <div style="font-size:10px;opacity:.6;margin-top:3px">${pct}% of total</div>
          </div>`;
      }
      document.getElementById('modelGrid').innerHTML = html || "<div class='empty'>ë°ì´í„° ì—†ìŒ</div>";
    }

    function renderLucaTeam(items) {
      const byAgent = { MAIN: null, REVIEWER: null, WORKER: null };
      const agentLabels = { MAIN: 'ğŸ‘‘ ë©”ì¸', REVIEWER: 'ğŸ” ë¦¬ë·°ì–´', WORKER: 'ğŸ› ï¸ ì›Œì»¤' };
      const agentCls   = { MAIN: 'luca-main', REVIEWER: 'luca-reviewer', WORKER: 'luca-worker' };

      for(const it of items) {
        if(!byAgent.hasOwnProperty(it.type)) continue;
        if(!byAgent[it.type] || it.updatedAt > byAgent[it.type].updatedAt) {
          byAgent[it.type] = it;
        }
      }

      let html = '';
      for(const [type, label] of Object.entries(agentLabels)) {
        const s = byAgent[type];
        if(!s) {
          html += `<div class="hero-item ${agentCls[type]}"><div class="label">${label}</div><div style="opacity:.5;font-size:12px">ì„¸ì…˜ ì—†ìŒ</div></div>`;
          continue;
        }
        html += `
          <div class="hero-item ${agentCls[type]}">
            <div class="label">${label}</div>
            <div class="row"><div class="k">ìƒíƒœ</div><div class="v"><span class="badge ${s.state}">${s.state}</span></div></div>
            <div class="row"><div class="k">ëª¨ë¸</div><div class="v" style="font-size:11px">${s.model||'-'}</div></div>
            <div class="row"><div class="k">ì±„ë„</div><div class="v" style="font-size:11px">${s.channel||'-'}</div></div>
            <div class="row"><div class="k">í† í°</div><div class="v">${fmtTokens(s.totalTokens)} (${s.percent}%)</div></div>
            <div class="bar" style="font-size:10px">${s.bar}</div>
            <div class="tiny">ì—…ë°ì´íŠ¸: ${humanizeAge(s.ageMin)} ì „</div>
          </div>`;
      }
      document.getElementById('lucaTeamGrid').innerHTML = html;
    }

    function renderSections(data){
      const items = data.items || [];
      const byType = {};
      for(const it of items){
        byType[it.type] = byType[it.type] || [];
        byType[it.type].push(it);
      }

      const order = ['MAIN','REVIEWER','WORKER','CRON','SUBAGENT','OTHER'];
      const html = order
        .filter(t => (byType[t]||[]).length > 0)
        .map(t => {
          const meta = TYPE_META[t] || TYPE_META.OTHER;
          return `
            <div class="section">${meta.icon} ${meta.name} <span style="opacity:.7;font-size:12px">(${byType[t].length})</span></div>
            <div class="grid">${byType[t].map(cardHTML).join('')}</div>`;
        }).join('');

      document.getElementById('sections').innerHTML = html || `<div class='empty'>í‘œì‹œí•  ì„¸ì…˜ì´ ì—†ì–´.</div>`;
    }

    async function load(){
      try {
        const res = await fetch('sessions.json?t=' + Date.now());
        const d = await res.json();
        latestData = d;

        document.getElementById('chips').innerHTML = `
          <div class='chip'>ì´ ì„¸ì…˜: <b>${d.summary.total}</b></div>
          <div class='chip'>ğŸŸ¢ ACTIVE: <b>${d.summary.active}</b></div>
          <div class='chip'>ğŸŸ¡ IDLE: <b>${d.summary.idle}</b></div>
          <div class='chip'>âš« STALE: <b>${d.summary.stale}</b></div>
          <div class='chip'>ğŸ” Reviewer: <b>${d.summary.byType?.REVIEWER||0}</b></div>
          <div class='chip'>ğŸ› ï¸ Worker: <b>${d.summary.byType?.WORKER||0}</b></div>
          <div class='chip'>ìŠ¤ëƒ…ìƒ·: <b>${d.generatedAtIso}</b></div>`;

        renderQuotaResets(d.summary.quotaResets);
        renderModelStats(d.summary.modelUsage);
        renderLucaTeam(d.items || []);
        renderSections(d);
      } catch(e) {
        console.error('load failed', e);
      }
    }

    initTheme();
    load();
    setInterval(load, 3000);
  </script>
</body>
</html>
